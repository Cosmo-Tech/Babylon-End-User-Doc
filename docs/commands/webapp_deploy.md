---
hide:
- toc
---
# WebApp Deploy

## Description

This macro command will create a static webapp and configure it with the webapp source code.

This includes:

  - Creating and configuring an Azure Static WebApp resource
  - Creating and configuring an Azure Active Directory App Registration
  - Configuring the WebApp source code
  - Adding access to the PowerBI Workspace

!!! abstract "Steps"
    Please follow the links to each command to check if all configuration variables are set.

    1. Creation of a Static WebApp resource `WebApp[deployment_name]`  
    ```bash
    babylon azure -c <context_id> -p <platform_id> staticwebapp create
    ```

    1. Creation of an Active Directory App Registration `App[deployment_name]`
    ```bash
    babylon azure -c <context_id> -p <platform_id> ad app create
    ```

    1. Create a password for azure function  
    ```bash
    babylon azure -c <context_id> -p <platform_id> ad app password create -n azf
    ```
    
    1. Create a password for powerbi  
    ```bash
    babylon azure -c <context_id> -p <platform_id> ad app password create -n pbi
    ```
    
    1. Adding the App Registration to the PowerBI Active Directory Group  
    ```bash
    babylon azure -c <context_id> -p <platform_id> ad group member add -pi <group_id> -pi %app%principal_id
    ```
    
    1. Deploy Azure Function 
    ```bash
    babylon azure -c <context_id> -p <platform_id> func deploy Arm[deployment_name]
    ```
    
    1. Update the StaticWebApp settings to link with the PowerBI workspace  
    ```bash
    babylon azure -c <context_id> -p <platform_id> staticwebapp app-settings update WebApp[deployment_name]
    ```
    
    1. Download the WebApp source code from github  
    ```bash
    babylon webapp -c <context_id> -p <platform_id> download webapp_src
    ```
    
    1. Update the workflow file generated by Azure to read a `config.json` file and set environment variables  
    ```bash
    babylon webapp -c <context_id> -p <platform_id> update-workflow <workflow_file>
    ```

    1. Export data from Babylon configuration in a `config.json` file to configure the WebApp  
    ```bash
    babylon webapp -c <context_id> -p <platform_id> export-config -o webapp_src/config.json
    ```

    1. Add/Commit/Push the `config.json` and the workflow files to the github repository  
    ```bash
    babylon webapp -c <context_id> -p <platform_id> upload-many -f webbap_src/config.json -f webapp_src/.github/workflows/
    ```


## Configuration

!!! warning "Requirements"
    This macro requires a github access token set in vault service.
    
    Please generate github access token using classic tokens [Github access Tokens](https://github.com/settings/tokens) and perform the following command:
    ```bash
    babylon hvac set global github token [github_pat_token]
    ```

!!! warning "Requirements"
    This macro requires a github repository with the destination branch already created
    
    1. [create a new repository](https://github.com/new) in Github
    3. configure your branch `<BRANCH>` with code source (e.g https://github.com/Cosmo-Tech/azure-sample-webapp.git)
    ```bash
      git init
      echo "# empty_webapp" >> README.md
      git add README.md
      git commit -m "first commit"
      git branch -M main
      git remote add origin git@github.com:<YOUR_GITHUB_REPOSITORY>.git
      git remote add upstream https://github.com/Cosmo-Tech/azure-sample-webapp.git
      git remote set-url upstream --push "NO"
      git fetch --all --prune
      git checkout -B <BRANCH> <SOURCE_TAG>
      rm -r .github/
      git add .; git commit -m 'first commit'
      git push origin <BRANCH> -f
    ```


!!! important "DNS Record"
    DNS Record creation is intently not supported by Babylon.  


## Macro command

!!! info "Macro"
    ```bash
    babylon webapp -c <context_id> -p <platfom_id> deploy
 
    ```
